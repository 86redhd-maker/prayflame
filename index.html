<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>기도의 불씨 · v3</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    /* 컬러 시스템: 더 차분하고 현대적인 팔레트 */
    --bg0:#0d1020;           /* 배경 */
    --bg1:#12172b;           /* 카드/표면 */
    --line:#1e2742;          /* 경계선 */
    --text:#eef1ff;          /* 본문 */
    --sub:#a7b0cc;           /* 보조 */
    --accent:#7aa7ff;        /* 포커스/프라이머리 */
    --accent-2:#b58cff;      /* 보조 포커스 */

    /* 스테이지 색 (불꽃) — 단계 클래스가 override */
    --outer:#ff7461; --mid:#ffb56a; --inner:#fff2cf;

    --radius:18px;
    --shadow-sm: 0 6px 18px rgba(0,0,0,.28);
    --shadow-lg: 0 24px 60px rgba(0,0,0,.36);
  }

  .stage-1{ --outer:#ff6a6a; --mid:#ffa06a; --inner:#ffe7c9; }
  .stage-2{ --outer:#ff904d; --mid:#ffc765; --inner:#fff2cc; }
  .stage-3{ --outer:#ffd34d; --mid:#ffe680; --inner:#fff9da; }
  .stage-4{ --outer:#fff6a8; --mid:#fff1cf; --inner:#ffffff; }

  html,body{ height:100%; margin:0; color:var(--text);
    font-family:"Noto Sans KR","Pretendard",-apple-system,system-ui,Segoe UI,Roboto,sans-serif; }
  body{
    background:
      radial-gradient(1200px 700px at 70% 10%, rgba(122,167,255,.10), transparent 60%),
      radial-gradient(900px 600px at 15% 20%, rgba(181,140,255,.10), transparent 60%),
      linear-gradient(180deg, #101533, var(--bg0) 55%);
  }

  .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center; padding:28px 16px 64px; }
  .card{
    width:min(880px, 94vw);
    background:color-mix(in oklab, var(--bg1) 92%, #fff 8%);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    padding:22px;
  }

  header{ text-align:center; margin-bottom:8px; }
  h1{ margin:.2rem 0 .1rem; letter-spacing:.01em; font-size:1.9rem; font-weight:600; }
  .subtitle{ color:var(--sub); font-size:.96rem; }

  .view{ display:none; } .view.active{ display:block; }
  .center{text-align:center;}

  /* 입력/텍스트 */
  textarea{
    width:100%; min-height:108px; padding:14px 16px;
    border-radius:12px; border:1px solid var(--line);
    background: #121831; color:var(--text); line-height:1.7; font-size:1rem;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
  }
  .tags{ display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 6px; }
  .tag{
    padding:8px 12px; border-radius:999px; font-size:.95rem;
    border:1px solid var(--line); background:#141a36; color:var(--text);
    transition: background .2s, border-color .2s;
  }
  .tag:hover{ border-color:#2a355a; }
  .tag.active{ background:#e7efff; color:#09122e; border-color:#c9d8ff; font-weight:600; }

  /* 버튼: 미니멀 · 라운드 · 고대비 포커스 */
  .btn{
    appearance:none; border:1px solid var(--line); color:var(--text);
    background:#141a36; border-radius:12px; padding:11px 14px; font-size:1rem; cursor:pointer;
    box-shadow: var(--shadow-sm); transition: transform .05s ease, border-color .2s, background .2s, opacity .2s;
  }
  .btn:hover{ transform: translateY(-1px); border-color:#2b3a66; }
  .btn:active{ transform: translateY(0); opacity:.85; }
  .btn.primary{
    border-color: color-mix(in oklab, var(--accent) 60%, var(--accent-2) 40%);
    background: linear-gradient(180deg,
      color-mix(in oklab, var(--accent) 55%, #fff 6%),
      color-mix(in oklab, var(--accent-2) 35%, #000 6%));
    color:#081229; font-weight:600;
  }
  .btn.ghost{
    background:transparent;
    border-color:#2b365c;
  }
  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px; }

  /* 불꽃 패널: 깔끔한 컨테이너 */
  .flame-panel{ display:flex; gap:22px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .flame-wrap{
    width:min(360px, 86vw); aspect-ratio:3/4; position:relative; border-radius:16px;
    background:
      radial-gradient(140px 120px at 50% 70%, rgba(255,210,150,.14), transparent 62%),
      radial-gradient(260px 200px at 50% 100%, rgba(255,150,110,.10), transparent 64%);
    border:1px solid var(--line);
    display:flex; align-items:center; justify-content:center;
  }

  /* 새 물방울형 불꽃 */
  .flame{ width:72%; height:auto; transform-origin:50% 100%; }
  .flicker{ animation:flicker 1.9s ease-in-out infinite; }
  @keyframes flicker{
    0%{ transform:translateY(0) scale(.99); }
    45%{ transform:translateY(-2px) scale(1.015); }
    100%{ transform:translateY(0) scale(1.0); }
  }

  /* 스파클은 4단계에서만 */
  .sparkles{ position:absolute; inset:0; pointer-events:none; opacity:.85; filter:blur(.2px); }
  .hide{display:none!important;}

  /* 기록 카드 */
  .entry{ padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#131937; margin-top:10px; }
  .entry .date{ color:var(--sub); font-size:.92rem; }
  .pill{ display:inline-block; padding:4px 8px; border-radius:999px; margin-left:6px; background:#0f142d; border:1px solid #2a355a; color:#cfe0ff; font-size:.82rem; }

  footer{ text-align:center; color:var(--sub); font-size:.85rem; margin-top:16px; }
  .note{ text-align:center; color:var(--sub); margin-top:8px; font-size:.95rem; }
</style>
</head>
<body>
<div class="wrap">
  <main class="card">
    <header>
      <div class="subtitle">웹 교구</div>
      <h1>기도의 불씨</h1>
      <div class="subtitle">물방울처럼 맑고 단정한 불꽃으로</div>
    </header>

    <!-- HOME -->
    <section id="view-home" class="view active center">
      <p style="font-family:'Nanum Pen Script',cursive; font-size:1.3rem;">“나의 기도 불씨를 키워보세요”</p>
      <div class="btn-row">
        <button id="btnStart" class="btn primary">시작하기</button>
        <button id="btnGoHistory" class="btn ghost">나의 기록 보기</button>
      </div>
    </section>

    <!-- INPUT -->
    <section id="view-input" class="view">
      <div style="font-family:'Nanum Pen Script',cursive; margin-bottom:6px;">하나님, 저는 …을(를) 위해 기도하고 싶어요.</div>
      <label for="txtPrayer" class="hide">기도 제목</label>
      <textarea id="txtPrayer" maxlength="300" placeholder="예: 아픈 친구의 회복을 위해, 가족의 평안을 위해, 시험을 준비하며…"></textarea>
      <div style="font-family:'Nanum Pen Script',cursive; margin-top:10px;">감정 태그를 선택해 주세요</div>
      <div id="tagList" class="tags" role="listbox" aria-label="감정 태그"></div>
      <div class="btn-row">
        <button id="btnSubmit" class="btn primary">불꽃 만들기</button>
        <button class="btn" data-goto="view-home">돌아가기</button>
      </div>
      <div class="note">※ 모든 내용은 이 기기 로컬에만 저장됩니다.</div>
    </section>

    <!-- FLAME -->
    <section id="view-flame" class="view center">
      <div class="flame-panel">
        <div id="flameContainer" class="flame-wrap stage-1" aria-live="polite">
          <!-- 물방울형 불꽃: 매끄러운 윤곽 + 코어 -->
          <svg id="flameSVG" class="flame flicker" viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="1.2" />
              </filter>
              <!-- 외곽/코어 그라디언트 -->
              <radialGradient id="outerG" cx="50%" cy="35%" r="70%">
                <stop offset="0%"  stop-color="var(--mid)"/>
                <stop offset="100%" stop-color="var(--outer)"/>
              </radialGradient>
              <radialGradient id="coreG" cx="50%" cy="45%" r="55%">
                <stop offset="0%"  stop-color="var(--inner)"/>
                <stop offset="100%" stop-color="var(--mid)"/>
              </radialGradient>
            </defs>

            <!-- 물방울 외곽: 꼬리 좁고 머리 둥글게 -->
            <path id="outer"
              d="M100 16
                 C 134 56, 168 104, 156 150
                 C 142 202, 110 236, 100 244
                 C  90 236,  58 202,  44 150
                 C  32 104,  66 56, 100 16 Z"
              fill="url(#outerG)" opacity=".95">
              <animate attributeName="d" dur="3.8s" repeatCount="indefinite" values="
                M100 16 C134 56,168 104,156 150 C142 202,110 236,100 244 C90 236,58 202,44 150 C32 104,66 56,100 16 Z;
                M100 15 C138 58,170 108,155 153 C140 203,110 236,100 244 C90 236,60 203,45 153 C30 108,62 58,100 15 Z;
                M100 16 C134 56,168 104,156 150 C142 202,110 236,100 244 C90 236,58 202,44 150 C32 104,66 56,100 16 Z"/>
            </path>

            <!-- 중간층 -->
            <path id="mid"
              d="M100 40
                 C 128 78, 154 118, 144 152
                 C 132 188, 110 214, 100 222
                 C  90 214,  68 188,  56 152
                 C  46 118,  72 78, 100 40 Z"
              fill="url(#coreG)" opacity=".98">
              <animate attributeName="d" dur="3.2s" repeatCount="indefinite" values="
                M100 40 C128 78,154 118,144 152 C132 188,110 214,100 222 C90 214,68 188,56 152 C46 118,72 78,100 40 Z;
                M100 39 C130 79,154 120,142 152 C130 186,110 214,100 222 C90 214,70 186,58 152 C46 120,70 79,100 39 Z;
                M100 40 C128 78,154 118,144 152 C132 188,110 214,100 222 C90 214,68 188,56 152 C46 118,72 78,100 40 Z"/>
            </path>

            <!-- 코어(가장 둥글고 작게) -->
            <path id="core"
              d="M100 76
                 C 116 100, 126 124, 121 142
                 C 114 164, 104 180, 100 186
                 C  96 180,  86 164,  79 142
                 C  74 124,  84 100, 100 76 Z"
              fill="var(--inner)" filter="url(#soft)" opacity=".98">
              <animate attributeName="d" dur="2.6s" repeatCount="indefinite" values="
                M100 76 C116 100,126 124,121 142 C114 164,104 180,100 186 C96 180,86 164,79 142 C74 124,84 100,100 76 Z;
                M100 74 C118 100,126 126,120 142 C114 160,104 178,100 184 C96 178,88 160,80 142 C74 126,82 100,100 74 Z;
                M100 76 C116 100,126 124,121 142 C114 164,104 180,100 186 C96 180,86 164,79 142 C74 124,84 100,100 76 Z"/>
            </path>
          </svg>

          <!-- 스테이지 4에서만 반짝 -->
          <svg id="sparkles" class="sparkles hide" viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg">
            <g fill="#fff" opacity=".95">
              <path d="M30 60 l6 12 12 6 -12 6 -6 12 -6 -12 -12 -6 12 -6z"/>
              <path d="M170 90 l4 10 10 4 -10 4 -4 10 -4 -10 -10 -4 10 -4z"/>
            </g>
          </svg>
        </div>

        <div style="min-width:260px;max-width:360px">
          <h2 style="margin:0 0 6px;">당신의 기도가 불꽃이 되었어요</h2>
          <div id="statusLine" class="subtitle">참여 0회 • 단계: 붉은 불씨 🔴</div>
          <div class="entry" id="lastEntryBox">
            <div class="date" id="lastDate">--</div>
            <div class="hand" id="lastText" style="font-family:'Nanum Pen Script',cursive; font-size:1.1rem;">—</div>
            <div><span class="pill" id="lastTag">—</span></div>
          </div>
          <div class="btn-row">
            <button id="btnSaveImage" class="btn primary">이미지 저장</button>
            <button id="btnCopyText"  class="btn">텍스트 복사</button>
            <button id="btnMore"      class="btn">다시 입력</button>
            <button id="btnToHistory" class="btn ghost">기록 보기</button>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="view-history" class="view">
      <div class="center">
        <h2 style="margin:0 0 6px;">나의 불꽃 기록</h2>
        <div id="historyStatus" class="subtitle">—</div>
        <div class="btn-row">
          <button data-goto="view-input" class="btn primary">새 기도 남기기</button>
          <button id="btnExportText" class="btn">전체 텍스트 복사</button>
          <button data-goto="view-home" class="btn ghost">홈으로</button>
        </div>
      </div>
      <div id="historyList" class="history"></div>
      <footer>로컬에 저장됨 · 이 브라우저에서만 보입니다</footer>
    </section>
  </main>
</div>

<script>
/* ===== 데이터 ===== */
const STORAGE_KEY='prayerSparks';
const TAGS=['감사','간구','회복','지혜','화해','용서','평안','인도','소망','찬양'];

const flameContainer=document.getElementById('flameContainer');
const sparkles=document.getElementById('sparkles');
const statusLine=document.getElementById('statusLine');
const lastDate=document.getElementById('lastDate');
const lastText=document.getElementById('lastText');
const lastTag=document.getElementById('lastTag');
const txtPrayer=document.getElementById('txtPrayer');
const tagList=document.getElementById('tagList');
const historyStatus=document.getElementById('historyStatus');
const historyList=document.getElementById('historyList');

function loadData(){
  try{ const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw){ const base={version:1,entries:[]}; localStorage.setItem(STORAGE_KEY, JSON.stringify(base)); return base; }
    const obj=JSON.parse(raw); if(!obj.version) obj.version=1; if(!Array.isArray(obj.entries)) obj.entries=[]; return obj;
  }catch{ return {version:1,entries:[]}; }
}
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function addEntry(text, tag){
  const d=loadData(); const e={id:String(Date.now()), text:text.trim(), tag:tag||'기타', dateISO:new Date().toISOString()};
  d.entries.push(e); saveData(d); return e;
}
function count(){ return loadData().entries.length; }
function stageInfo(n){
  if(n>=10) return {id:4, name:'빛나는 불꽃 ✨', cls:'stage-4'};
  if(n>=5)  return {id:3, name:'금빛 불꽃 🟡', cls:'stage-3'};
  if(n>=3)  return {id:2, name:'주황 불꽃 🟠', cls:'stage-2'};
  if(n>=1)  return {id:1, name:'붉은 불씨 🔴', cls:'stage-1'};
  return {id:0, name:'—', cls:'stage-1'};
}
function fmt(iso){ const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function goTo(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }

let selectedTag=null;
function buildTags(){
  tagList.innerHTML=''; TAGS.forEach(t=>{ const b=document.createElement('button'); b.type='button'; b.className='tag'; b.textContent=t;
    b.addEventListener('click',()=>{ selectedTag=(selectedTag===t)?null:t; [...tagList.children].forEach(ch=>ch.classList.toggle('active', ch.textContent===selectedTag)); });
    tagList.appendChild(b);
  });
}
buildTags();

/* submit */
document.getElementById('btnStart').addEventListener('click',()=>goTo('view-input'));
document.getElementById('btnGoHistory').addEventListener('click',()=>{ renderHistory(); goTo('view-history'); });
document.querySelectorAll('[data-goto]').forEach(b=>b.addEventListener('click',()=>goTo(b.getAttribute('data-goto'))));
document.getElementById('btnSubmit').addEventListener('click',()=>{
  const text=txtPrayer.value.trim(); if(!text){ alert('기도 제목을 적어 주세요.'); txtPrayer.focus(); return; }
  const e=addEntry(text, selectedTag||'기타'); txtPrayer.value=''; selectedTag=null; [...tagList.children].forEach(ch=>ch.classList.remove('active'));
  renderFlame(e); goTo('view-flame');
});

/* flame render */
function renderFlame(latest=null){
  const n=count(); const st=stageInfo(n);
  flameContainer.classList.remove('stage-1','stage-2','stage-3','stage-4'); flameContainer.classList.add(st.cls);
  statusLine.textContent=`참여 ${n}회 • 단계: ${st.name}`;
  const d=loadData(); const last=latest||d.entries[d.entries.length-1]; if(last){ lastDate.textContent=fmt(last.dateISO); lastText.textContent=last.text; lastTag.textContent=last.tag; }
  sparkles.classList.toggle('hide', st.id!==4);
}
renderFlame();

/* history */
function renderHistory(){
  const d=loadData(); const n=d.entries.length; const st=stageInfo(n);
  historyStatus.textContent=`참여 ${n}회 • 현재 단계: ${st.name}`;
  historyList.innerHTML='';
  if(n===0){ historyList.innerHTML='<div class="note">아직 기록이 없어요. 오늘 첫 불씨를 남겨 보세요.</div>'; return; }
  [...d.entries].reverse().forEach(e=>{
    const div=document.createElement('div'); div.className='entry';
    div.innerHTML=`<div class="date">${fmt(e.dateISO)} <span class="pill">${e.tag}</span></div>
                   <div style="font-family:'Nanum Pen Script',cursive; margin-top:6px; font-size:1.05rem;">${escapeHTML(e.text)}</div>`;
    historyList.appendChild(div);
  });
}

/* copy/export */
function summaryText(){
  const d=loadData(); const n=d.entries.length; const st=stageInfo(n);
  return ['【나의 기도 불꽃】',`참여 ${n}회 • 단계: ${st.name}`,'', ...d.entries.map((e,i)=>`${i+1}. ${fmt(e.dateISO)} [${e.tag}] ${e.text}`)].join('\n');
}
document.getElementById('btnCopyText').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(summaryText()); toast('텍스트를 복사했어요.'); }
  catch{ prompt('복사할 텍스트입니다. 수동 복사하세요:', summaryText()); }
});
document.getElementById('btnExportText').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(summaryText()); toast('전체 기록을 복사했어요.'); }
  catch{ prompt('복사할 텍스트입니다. 수동 복사하세요:', summaryText()); }
});

/* image export: SVG → PNG */
document.getElementById('btnSaveImage').addEventListener('click', async ()=>{
  const d=loadData(); const last=d.entries[d.entries.length-1]; const n=count(); const st=stageInfo(n);
  const W=1000,H=1400; const c=document.createElement('canvas'); c.width=W; c.height=H; const ctx=c.getContext('2d');

  // 배경
  const grd=ctx.createLinearGradient(0,0,0,H); grd.addColorStop(0,'#11163a'); grd.addColorStop(1,'#0c1024'); ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

  // 제목
  ctx.fillStyle='#eef1ff'; ctx.font='600 56px "Noto Sans KR",sans-serif'; ctx.textAlign='center'; ctx.fillText('나의 기도 불꽃', W/2, 120);
  ctx.font='400 28px "Noto Sans KR",sans-serif'; ctx.fillStyle='#a7b0cc'; ctx.fillText(`참여 ${n}회 • ${st.name}`, W/2, 170);

  // flame SVG rasterize
  const svg=document.getElementById('flameSVG').cloneNode(true);
  const svgTxt=new XMLSerializer().serializeToString(svg);
  const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgTxt);
  await new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>{ctx.drawImage(img, W/2-210, 300, 420, 560); res();}; img.onerror=rej; img.src=url; });

  // 카드
  roundRect(ctx,120,900,W-240,300,18); ctx.fillStyle='rgba(255,255,255,.06)'; ctx.fill();
  ctx.font='400 24px "Noto Sans KR",sans-serif'; ctx.fillStyle='#a7b0cc'; ctx.textAlign='left'; ctx.fillText(fmt(last.dateISO)+' • '+last.tag,150,950);
  ctx.font='32px "Nanum Pen Script",cursive'; ctx.fillStyle='#eef1ff'; wrap(ctx, `“${last.text}”`, 150, 996, W-300, 46);

  const png=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=png; a.download=`나의_기도_불꽃_${fmt(last.dateISO)}.png`; document.body.appendChild(a); a.click(); a.remove();
  toast('이미지를 저장했어요!');
});

/* util */
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function wrap(ctx,text,x,y,max,line){ const chars=text.split(''); let lineStr=''; for(let i=0;i<chars.length;i++){ const t=lineStr+chars[i]; if(ctx.measureText(t).width>max && i>0){ ctx.fillText(lineStr,x,y); lineStr=chars[i]; y+=line; } else lineStr=t; } ctx.fillText(lineStr,x,y); }
function toast(msg){ const el=document.createElement('div'); el.textContent=msg; Object.assign(el.style,{position:'fixed',left:'50%',bottom:'26px',transform:'translateX(-50%)',background:'#0e1228',color:'#eef1ff',border:'1px solid #1e2742',padding:'10px 14px',borderRadius:'10px',zIndex:9999}); document.body.appendChild(el); setTimeout(()=>{el.style.transition='opacity .35s'; el.style.opacity='0';},1200); setTimeout(()=>el.remove(),1650); }
function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* nav in flame */
document.getElementById('btnMore').addEventListener('click',()=>goTo('view-input'));
document.getElementById('btnToHistory').addEventListener('click',()=>{ renderHistory(); goTo('view-history'); });

/* init */
function renderFlame(){/* stub to avoid hoist warning */} // already defined above
renderHistory();
</script>
</body>
</html>
