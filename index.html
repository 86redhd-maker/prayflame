<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê¸°ë„ì˜ ë¶ˆì”¨ Â· v3</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    /* ì»¬ëŸ¬ ì‹œìŠ¤í…œ: ë” ì°¨ë¶„í•˜ê³  í˜„ëŒ€ì ì¸ íŒ”ë ˆíŠ¸ */
    --bg0:#0d1020;           /* ë°°ê²½ */
    --bg1:#12172b;           /* ì¹´ë“œ/í‘œë©´ */
    --line:#1e2742;          /* ê²½ê³„ì„  */
    --text:#eef1ff;          /* ë³¸ë¬¸ */
    --sub:#a7b0cc;           /* ë³´ì¡° */
    --accent:#7aa7ff;        /* í¬ì»¤ìŠ¤/í”„ë¼ì´ë¨¸ë¦¬ */
    --accent-2:#b58cff;      /* ë³´ì¡° í¬ì»¤ìŠ¤ */

    /* ìŠ¤í…Œì´ì§€ ìƒ‰ (ë¶ˆê½ƒ) â€” ë‹¨ê³„ í´ë˜ìŠ¤ê°€ override */
    --outer:#ff7461; --mid:#ffb56a; --inner:#fff2cf;

    --radius:18px;
    --shadow-sm: 0 6px 18px rgba(0,0,0,.28);
    --shadow-lg: 0 24px 60px rgba(0,0,0,.36);
  }

  .stage-1{ --outer:#ff6a6a; --mid:#ffa06a; --inner:#ffe7c9; }
  .stage-2{ --outer:#ff904d; --mid:#ffc765; --inner:#fff2cc; }
  .stage-3{ --outer:#ffd34d; --mid:#ffe680; --inner:#fff9da; }
  .stage-4{ --outer:#fff6a8; --mid:#fff1cf; --inner:#ffffff; }

  html,body{ height:100%; margin:0; color:var(--text);
    font-family:"Noto Sans KR","Pretendard",-apple-system,system-ui,Segoe UI,Roboto,sans-serif; }
  body{
    background:
      radial-gradient(1200px 700px at 70% 10%, rgba(122,167,255,.10), transparent 60%),
      radial-gradient(900px 600px at 15% 20%, rgba(181,140,255,.10), transparent 60%),
      linear-gradient(180deg, #101533, var(--bg0) 55%);
  }

  .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center; padding:28px 16px 64px; }
  .card{
    width:min(880px, 94vw);
    background:color-mix(in oklab, var(--bg1) 92%, #fff 8%);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    padding:22px;
  }

  header{ text-align:center; margin-bottom:8px; }
  h1{ margin:.2rem 0 .1rem; letter-spacing:.01em; font-size:1.9rem; font-weight:600; }
  .subtitle{ color:var(--sub); font-size:.96rem; }

  .view{ display:none; } .view.active{ display:block; }
  .center{text-align:center;}

  /* ì…ë ¥/í…ìŠ¤íŠ¸ */
  textarea{
    width:100%; min-height:108px; padding:14px 16px;
    border-radius:12px; border:1px solid var(--line);
    background: #121831; color:var(--text); line-height:1.7; font-size:1rem;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
  }
  .tags{ display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 6px; }
  .tag{
    padding:8px 12px; border-radius:999px; font-size:.95rem;
    border:1px solid var(--line); background:#141a36; color:var(--text);
    transition: background .2s, border-color .2s;
  }
  .tag:hover{ border-color:#2a355a; }
  .tag.active{ background:#e7efff; color:#09122e; border-color:#c9d8ff; font-weight:600; }

  /* ë²„íŠ¼: ë¯¸ë‹ˆë©€ Â· ë¼ìš´ë“œ Â· ê³ ëŒ€ë¹„ í¬ì»¤ìŠ¤ */
  .btn{
    appearance:none; border:1px solid var(--line); color:var(--text);
    background:#141a36; border-radius:12px; padding:11px 14px; font-size:1rem; cursor:pointer;
    box-shadow: var(--shadow-sm); transition: transform .05s ease, border-color .2s, background .2s, opacity .2s;
  }
  .btn:hover{ transform: translateY(-1px); border-color:#2b3a66; }
  .btn:active{ transform: translateY(0); opacity:.85; }
  .btn.primary{
    border-color: color-mix(in oklab, var(--accent) 60%, var(--accent-2) 40%);
    background: linear-gradient(180deg,
      color-mix(in oklab, var(--accent) 55%, #fff 6%),
      color-mix(in oklab, var(--accent-2) 35%, #000 6%));
    color:#081229; font-weight:600;
  }
  .btn.ghost{
    background:transparent;
    border-color:#2b365c;
  }
  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px; }

  /* ë¶ˆê½ƒ íŒ¨ë„: ê¹”ë”í•œ ì»¨í…Œì´ë„ˆ */
  .flame-panel{ display:flex; gap:22px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .flame-wrap{
    width:min(360px, 86vw); aspect-ratio:3/4; position:relative; border-radius:16px;
    background:
      radial-gradient(140px 120px at 50% 70%, rgba(255,210,150,.14), transparent 62%),
      radial-gradient(260px 200px at 50% 100%, rgba(255,150,110,.10), transparent 64%);
    border:1px solid var(--line);
    display:flex; align-items:center; justify-content:center;
  }

  /* ìƒˆ ë¬¼ë°©ìš¸í˜• ë¶ˆê½ƒ */
  .flame{ width:72%; height:auto; transform-origin:50% 100%; }
  .flicker{ animation:flicker 1.9s ease-in-out infinite; }
  @keyframes flicker{
    0%{ transform:translateY(0) scale(.99); }
    45%{ transform:translateY(-2px) scale(1.015); }
    100%{ transform:translateY(0) scale(1.0); }
  }

  /* ìŠ¤íŒŒí´ì€ 4ë‹¨ê³„ì—ì„œë§Œ */
  .sparkles{ position:absolute; inset:0; pointer-events:none; opacity:.85; filter:blur(.2px); }
  .hide{display:none!important;}

  /* ê¸°ë¡ ì¹´ë“œ */
  .entry{ padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#131937; margin-top:10px; }
  .entry .date{ color:var(--sub); font-size:.92rem; }
  .pill{ display:inline-block; padding:4px 8px; border-radius:999px; margin-left:6px; background:#0f142d; border:1px solid #2a355a; color:#cfe0ff; font-size:.82rem; }

  footer{ text-align:center; color:var(--sub); font-size:.85rem; margin-top:16px; }
  .note{ text-align:center; color:var(--sub); margin-top:8px; font-size:.95rem; }
</style>
</head>
<body>
<div class="wrap">
  <main class="card">
    <header>
      <div class="subtitle">ì›¹ êµêµ¬</div>
      <h1>ê¸°ë„ì˜ ë¶ˆì”¨</h1>
      <div class="subtitle">ë¬¼ë°©ìš¸ì²˜ëŸ¼ ë§‘ê³  ë‹¨ì •í•œ ë¶ˆê½ƒìœ¼ë¡œ</div>
    </header>

    <!-- HOME -->
    <section id="view-home" class="view active center">
      <p style="font-family:'Nanum Pen Script',cursive; font-size:1.3rem;">â€œë‚˜ì˜ ê¸°ë„ ë¶ˆì”¨ë¥¼ í‚¤ì›Œë³´ì„¸ìš”â€</p>
      <div class="btn-row">
        <button id="btnStart" class="btn primary">ì‹œì‘í•˜ê¸°</button>
        <button id="btnGoHistory" class="btn ghost">ë‚˜ì˜ ê¸°ë¡ ë³´ê¸°</button>
      </div>
    </section>

    <!-- INPUT -->
    <section id="view-input" class="view">
      <div style="font-family:'Nanum Pen Script',cursive; margin-bottom:6px;">í•˜ë‚˜ë‹˜, ì €ëŠ” â€¦ì„(ë¥¼) ìœ„í•´ ê¸°ë„í•˜ê³  ì‹¶ì–´ìš”.</div>
      <label for="txtPrayer" class="hide">ê¸°ë„ ì œëª©</label>
      <textarea id="txtPrayer" maxlength="300" placeholder="ì˜ˆ: ì•„í”ˆ ì¹œêµ¬ì˜ íšŒë³µì„ ìœ„í•´, ê°€ì¡±ì˜ í‰ì•ˆì„ ìœ„í•´, ì‹œí—˜ì„ ì¤€ë¹„í•˜ë©°â€¦"></textarea>
      <div style="font-family:'Nanum Pen Script',cursive; margin-top:10px;">ê°ì • íƒœê·¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
      <div id="tagList" class="tags" role="listbox" aria-label="ê°ì • íƒœê·¸"></div>
      <div class="btn-row">
        <button id="btnSubmit" class="btn primary">ë¶ˆê½ƒ ë§Œë“¤ê¸°</button>
        <button class="btn" data-goto="view-home">ëŒì•„ê°€ê¸°</button>
      </div>
      <div class="note">â€» ëª¨ë“  ë‚´ìš©ì€ ì´ ê¸°ê¸° ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </section>

    <!-- FLAME -->
    <section id="view-flame" class="view center">
      <div class="flame-panel">
        <div id="flameContainer" class="flame-wrap stage-1" aria-live="polite">
          <!-- ë¬¼ë°©ìš¸í˜• ë¶ˆê½ƒ: ë§¤ë„ëŸ¬ìš´ ìœ¤ê³½ + ì½”ì–´ -->
          <svg id="flameSVG" class="flame flicker" viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="1.2" />
              </filter>
              <!-- ì™¸ê³½/ì½”ì–´ ê·¸ë¼ë””ì–¸íŠ¸ -->
              <radialGradient id="outerG" cx="50%" cy="35%" r="70%">
                <stop offset="0%"  stop-color="var(--mid)"/>
                <stop offset="100%" stop-color="var(--outer)"/>
              </radialGradient>
              <radialGradient id="coreG" cx="50%" cy="45%" r="55%">
                <stop offset="0%"  stop-color="var(--inner)"/>
                <stop offset="100%" stop-color="var(--mid)"/>
              </radialGradient>
            </defs>

            <!-- ë¬¼ë°©ìš¸ ì™¸ê³½: ê¼¬ë¦¬ ì¢ê³  ë¨¸ë¦¬ ë‘¥ê¸€ê²Œ -->
            <path id="outer"
              d="M100 16
                 C 134 56, 168 104, 156 150
                 C 142 202, 110 236, 100 244
                 C  90 236,  58 202,  44 150
                 C  32 104,  66 56, 100 16 Z"
              fill="url(#outerG)" opacity=".95">
              <animate attributeName="d" dur="3.8s" repeatCount="indefinite" values="
                M100 16 C134 56,168 104,156 150 C142 202,110 236,100 244 C90 236,58 202,44 150 C32 104,66 56,100 16 Z;
                M100 15 C138 58,170 108,155 153 C140 203,110 236,100 244 C90 236,60 203,45 153 C30 108,62 58,100 15 Z;
                M100 16 C134 56,168 104,156 150 C142 202,110 236,100 244 C90 236,58 202,44 150 C32 104,66 56,100 16 Z"/>
            </path>

            <!-- ì¤‘ê°„ì¸µ -->
            <path id="mid"
              d="M100 40
                 C 128 78, 154 118, 144 152
                 C 132 188, 110 214, 100 222
                 C  90 214,  68 188,  56 152
                 C  46 118,  72 78, 100 40 Z"
              fill="url(#coreG)" opacity=".98">
              <animate attributeName="d" dur="3.2s" repeatCount="indefinite" values="
                M100 40 C128 78,154 118,144 152 C132 188,110 214,100 222 C90 214,68 188,56 152 C46 118,72 78,100 40 Z;
                M100 39 C130 79,154 120,142 152 C130 186,110 214,100 222 C90 214,70 186,58 152 C46 120,70 79,100 39 Z;
                M100 40 C128 78,154 118,144 152 C132 188,110 214,100 222 C90 214,68 188,56 152 C46 118,72 78,100 40 Z"/>
            </path>

            <!-- ì½”ì–´(ê°€ì¥ ë‘¥ê¸€ê³  ì‘ê²Œ) -->
            <path id="core"
              d="M100 76
                 C 116 100, 126 124, 121 142
                 C 114 164, 104 180, 100 186
                 C  96 180,  86 164,  79 142
                 C  74 124,  84 100, 100 76 Z"
              fill="var(--inner)" filter="url(#soft)" opacity=".98">
              <animate attributeName="d" dur="2.6s" repeatCount="indefinite" values="
                M100 76 C116 100,126 124,121 142 C114 164,104 180,100 186 C96 180,86 164,79 142 C74 124,84 100,100 76 Z;
                M100 74 C118 100,126 126,120 142 C114 160,104 178,100 184 C96 178,88 160,80 142 C74 126,82 100,100 74 Z;
                M100 76 C116 100,126 124,121 142 C114 164,104 180,100 186 C96 180,86 164,79 142 C74 124,84 100,100 76 Z"/>
            </path>
          </svg>

          <!-- ìŠ¤í…Œì´ì§€ 4ì—ì„œë§Œ ë°˜ì§ -->
          <svg id="sparkles" class="sparkles hide" viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg">
            <g fill="#fff" opacity=".95">
              <path d="M30 60 l6 12 12 6 -12 6 -6 12 -6 -12 -12 -6 12 -6z"/>
              <path d="M170 90 l4 10 10 4 -10 4 -4 10 -4 -10 -10 -4 10 -4z"/>
            </g>
          </svg>
        </div>

        <div style="min-width:260px;max-width:360px">
          <h2 style="margin:0 0 6px;">ë‹¹ì‹ ì˜ ê¸°ë„ê°€ ë¶ˆê½ƒì´ ë˜ì—ˆì–´ìš”</h2>
          <div id="statusLine" class="subtitle">ì°¸ì—¬ 0íšŒ â€¢ ë‹¨ê³„: ë¶‰ì€ ë¶ˆì”¨ ğŸ”´</div>
          <div class="entry" id="lastEntryBox">
            <div class="date" id="lastDate">--</div>
            <div class="hand" id="lastText" style="font-family:'Nanum Pen Script',cursive; font-size:1.1rem;">â€”</div>
            <div><span class="pill" id="lastTag">â€”</span></div>
          </div>
          <div class="btn-row">
            <button id="btnSaveImage" class="btn primary">ì´ë¯¸ì§€ ì €ì¥</button>
            <button id="btnCopyText"  class="btn">í…ìŠ¤íŠ¸ ë³µì‚¬</button>
            <button id="btnMore"      class="btn">ë‹¤ì‹œ ì…ë ¥</button>
            <button id="btnToHistory" class="btn ghost">ê¸°ë¡ ë³´ê¸°</button>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="view-history" class="view">
      <div class="center">
        <h2 style="margin:0 0 6px;">ë‚˜ì˜ ë¶ˆê½ƒ ê¸°ë¡</h2>
        <div id="historyStatus" class="subtitle">â€”</div>
        <div class="btn-row">
          <button data-goto="view-input" class="btn primary">ìƒˆ ê¸°ë„ ë‚¨ê¸°ê¸°</button>
          <button id="btnExportText" class="btn">ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
          <button data-goto="view-home" class="btn ghost">í™ˆìœ¼ë¡œ</button>
        </div>
      </div>
      <div id="historyList" class="history"></div>
      <footer>ë¡œì»¬ì— ì €ì¥ë¨ Â· ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ë³´ì…ë‹ˆë‹¤</footer>
    </section>
  </main>
</div>

<script>
/* ===== ë°ì´í„° ===== */
const STORAGE_KEY='prayerSparks';
const TAGS=['ê°ì‚¬','ê°„êµ¬','íšŒë³µ','ì§€í˜œ','í™”í•´','ìš©ì„œ','í‰ì•ˆ','ì¸ë„','ì†Œë§','ì°¬ì–‘'];

const flameContainer=document.getElementById('flameContainer');
const sparkles=document.getElementById('sparkles');
const statusLine=document.getElementById('statusLine');
const lastDate=document.getElementById('lastDate');
const lastText=document.getElementById('lastText');
const lastTag=document.getElementById('lastTag');
const txtPrayer=document.getElementById('txtPrayer');
const tagList=document.getElementById('tagList');
const historyStatus=document.getElementById('historyStatus');
const historyList=document.getElementById('historyList');

function loadData(){
  try{ const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw){ const base={version:1,entries:[]}; localStorage.setItem(STORAGE_KEY, JSON.stringify(base)); return base; }
    const obj=JSON.parse(raw); if(!obj.version) obj.version=1; if(!Array.isArray(obj.entries)) obj.entries=[]; return obj;
  }catch{ return {version:1,entries:[]}; }
}
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function addEntry(text, tag){
  const d=loadData(); const e={id:String(Date.now()), text:text.trim(), tag:tag||'ê¸°íƒ€', dateISO:new Date().toISOString()};
  d.entries.push(e); saveData(d); return e;
}
function count(){ return loadData().entries.length; }
function stageInfo(n){
  if(n>=10) return {id:4, name:'ë¹›ë‚˜ëŠ” ë¶ˆê½ƒ âœ¨', cls:'stage-4'};
  if(n>=5)  return {id:3, name:'ê¸ˆë¹› ë¶ˆê½ƒ ğŸŸ¡', cls:'stage-3'};
  if(n>=3)  return {id:2, name:'ì£¼í™© ë¶ˆê½ƒ ğŸŸ ', cls:'stage-2'};
  if(n>=1)  return {id:1, name:'ë¶‰ì€ ë¶ˆì”¨ ğŸ”´', cls:'stage-1'};
  return {id:0, name:'â€”', cls:'stage-1'};
}
function fmt(iso){ const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function goTo(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }

let selectedTag=null;
function buildTags(){
  tagList.innerHTML=''; TAGS.forEach(t=>{ const b=document.createElement('button'); b.type='button'; b.className='tag'; b.textContent=t;
    b.addEventListener('click',()=>{ selectedTag=(selectedTag===t)?null:t; [...tagList.children].forEach(ch=>ch.classList.toggle('active', ch.textContent===selectedTag)); });
    tagList.appendChild(b);
  });
}
buildTags();

/* submit */
document.getElementById('btnStart').addEventListener('click',()=>goTo('view-input'));
document.getElementById('btnGoHistory').addEventListener('click',()=>{ renderHistory(); goTo('view-history'); });
document.querySelectorAll('[data-goto]').forEach(b=>b.addEventListener('click',()=>goTo(b.getAttribute('data-goto'))));
document.getElementById('btnSubmit').addEventListener('click',()=>{
  const text=txtPrayer.value.trim(); if(!text){ alert('ê¸°ë„ ì œëª©ì„ ì ì–´ ì£¼ì„¸ìš”.'); txtPrayer.focus(); return; }
  const e=addEntry(text, selectedTag||'ê¸°íƒ€'); txtPrayer.value=''; selectedTag=null; [...tagList.children].forEach(ch=>ch.classList.remove('active'));
  renderFlame(e); goTo('view-flame');
});

/* flame render */
function renderFlame(latest=null){
  const n=count(); const st=stageInfo(n);
  flameContainer.classList.remove('stage-1','stage-2','stage-3','stage-4'); flameContainer.classList.add(st.cls);
  statusLine.textContent=`ì°¸ì—¬ ${n}íšŒ â€¢ ë‹¨ê³„: ${st.name}`;
  const d=loadData(); const last=latest||d.entries[d.entries.length-1]; if(last){ lastDate.textContent=fmt(last.dateISO); lastText.textContent=last.text; lastTag.textContent=last.tag; }
  sparkles.classList.toggle('hide', st.id!==4);
}
renderFlame();

/* history */
function renderHistory(){
  const d=loadData(); const n=d.entries.length; const st=stageInfo(n);
  historyStatus.textContent=`ì°¸ì—¬ ${n}íšŒ â€¢ í˜„ì¬ ë‹¨ê³„: ${st.name}`;
  historyList.innerHTML='';
  if(n===0){ historyList.innerHTML='<div class="note">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. ì˜¤ëŠ˜ ì²« ë¶ˆì”¨ë¥¼ ë‚¨ê²¨ ë³´ì„¸ìš”.</div>'; return; }
  [...d.entries].reverse().forEach(e=>{
    const div=document.createElement('div'); div.className='entry';
    div.innerHTML=`<div class="date">${fmt(e.dateISO)} <span class="pill">${e.tag}</span></div>
                   <div style="font-family:'Nanum Pen Script',cursive; margin-top:6px; font-size:1.05rem;">${escapeHTML(e.text)}</div>`;
    historyList.appendChild(div);
  });
}

/* copy/export */
function summaryText(){
  const d=loadData(); const n=d.entries.length; const st=stageInfo(n);
  return ['ã€ë‚˜ì˜ ê¸°ë„ ë¶ˆê½ƒã€‘',`ì°¸ì—¬ ${n}íšŒ â€¢ ë‹¨ê³„: ${st.name}`,'', ...d.entries.map((e,i)=>`${i+1}. ${fmt(e.dateISO)} [${e.tag}] ${e.text}`)].join('\n');
}
document.getElementById('btnCopyText').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(summaryText()); toast('í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆì–´ìš”.'); }
  catch{ prompt('ë³µì‚¬í•  í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”:', summaryText()); }
});
document.getElementById('btnExportText').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(summaryText()); toast('ì „ì²´ ê¸°ë¡ì„ ë³µì‚¬í–ˆì–´ìš”.'); }
  catch{ prompt('ë³µì‚¬í•  í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”:', summaryText()); }
});

/* image export: SVG â†’ PNG */
document.getElementById('btnSaveImage').addEventListener('click', async ()=>{
  const d=loadData(); const last=d.entries[d.entries.length-1]; const n=count(); const st=stageInfo(n);
  const W=1000,H=1400; const c=document.createElement('canvas'); c.width=W; c.height=H; const ctx=c.getContext('2d');

  // ë°°ê²½
  const grd=ctx.createLinearGradient(0,0,0,H); grd.addColorStop(0,'#11163a'); grd.addColorStop(1,'#0c1024'); ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

  // ì œëª©
  ctx.fillStyle='#eef1ff'; ctx.font='600 56px "Noto Sans KR",sans-serif'; ctx.textAlign='center'; ctx.fillText('ë‚˜ì˜ ê¸°ë„ ë¶ˆê½ƒ', W/2, 120);
  ctx.font='400 28px "Noto Sans KR",sans-serif'; ctx.fillStyle='#a7b0cc'; ctx.fillText(`ì°¸ì—¬ ${n}íšŒ â€¢ ${st.name}`, W/2, 170);

  // flame SVG rasterize
  const svg=document.getElementById('flameSVG').cloneNode(true);
  const svgTxt=new XMLSerializer().serializeToString(svg);
  const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgTxt);
  await new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>{ctx.drawImage(img, W/2-210, 300, 420, 560); res();}; img.onerror=rej; img.src=url; });

  // ì¹´ë“œ
  roundRect(ctx,120,900,W-240,300,18); ctx.fillStyle='rgba(255,255,255,.06)'; ctx.fill();
  ctx.font='400 24px "Noto Sans KR",sans-serif'; ctx.fillStyle='#a7b0cc'; ctx.textAlign='left'; ctx.fillText(fmt(last.dateISO)+' â€¢ '+last.tag,150,950);
  ctx.font='32px "Nanum Pen Script",cursive'; ctx.fillStyle='#eef1ff'; wrap(ctx, `â€œ${last.text}â€`, 150, 996, W-300, 46);

  const png=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=png; a.download=`ë‚˜ì˜_ê¸°ë„_ë¶ˆê½ƒ_${fmt(last.dateISO)}.png`; document.body.appendChild(a); a.click(); a.remove();
  toast('ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆì–´ìš”!');
});

/* util */
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function wrap(ctx,text,x,y,max,line){ const chars=text.split(''); let lineStr=''; for(let i=0;i<chars.length;i++){ const t=lineStr+chars[i]; if(ctx.measureText(t).width>max && i>0){ ctx.fillText(lineStr,x,y); lineStr=chars[i]; y+=line; } else lineStr=t; } ctx.fillText(lineStr,x,y); }
function toast(msg){ const el=document.createElement('div'); el.textContent=msg; Object.assign(el.style,{position:'fixed',left:'50%',bottom:'26px',transform:'translateX(-50%)',background:'#0e1228',color:'#eef1ff',border:'1px solid #1e2742',padding:'10px 14px',borderRadius:'10px',zIndex:9999}); document.body.appendChild(el); setTimeout(()=>{el.style.transition='opacity .35s'; el.style.opacity='0';},1200); setTimeout(()=>el.remove(),1650); }
function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* nav in flame */
document.getElementById('btnMore').addEventListener('click',()=>goTo('view-input'));
document.getElementById('btnToHistory').addEventListener('click',()=>{ renderHistory(); goTo('view-history'); });

/* init */
function renderFlame(){/* stub to avoid hoist warning */} // already defined above
renderHistory();
</script>
</body>
</html>
