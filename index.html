<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>기도의 불씨 · v2</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
<style>
  :root{
    /* 새 팔레트: 미드나이트 인디고 + 라일락 글로우 */
    --bg-top:#0f1430;
    --bg-bot:#070b1e;
    --halo-1:rgba(172,137,255,.18);
    --halo-2:rgba(118,209,255,.12);

    --text:#eef1ff;
    --muted:#b8c0e0;

    /* 단계별 불꽃 색 (기본값은 stage 클래스가 바꿔줌) */
    --flame-outer:#ff6868;
    --flame-mid:#ffb36b;
    --flame-inner:#fff1c7;

    --scale:1;
    --glow:0 0 26px rgba(255,150,80,.35), 0 0 80px rgba(255,210,120,.22);
  }

  /* 단계 클래스 */
  .stage-1{ --flame-outer:#ff6d7a; --flame-mid:#ff9c6d; --flame-inner:#ffe8c7; --scale:1.0; --glow:0 0 24px rgba(255,120,120,.35),0 0 60px rgba(255,170,120,.22); }
  .stage-2{ --flame-outer:#ff934d; --flame-mid:#ffc764; --flame-inner:#fff1cc; --scale:1.15; --glow:0 0 28px rgba(255,147,77,.45),0 0 90px rgba(255,199,100,.30); }
  .stage-3{ --flame-outer:#ffd34d; --flame-mid:#ffe680; --flame-inner:#fff8d6; --scale:1.3; --glow:0 0 34px rgba(255,211,77,.55),0 0 120px rgba(255,230,128,.38); }
  .stage-4{ --flame-outer:#fff7b1; --flame-mid:#fff2d0; --flame-inner:#ffffff; --scale:1.45; --glow:0 0 42px rgba(255,247,177,.75),0 0 160px rgba(255,255,230,.55); }

  html,body{ height:100%; margin:0; color:var(--text); font-family:"Gowun Dodum", system-ui, -apple-system, "Noto Sans KR", sans-serif; }
  body{
    background:
      radial-gradient(1000px 600px at 15% 10%, var(--halo-1), transparent 60%),
      radial-gradient(1200px 700px at 85% 20%, var(--halo-2), transparent 65%),
      linear-gradient(180deg, var(--bg-top), var(--bg-bot) 62%);
  }

  /* 별빛 */
  .stars,.stars:after{
    position:fixed; inset:0; pointer-events:none; content:"";
    background:
      radial-gradient(1.6px 1.6px at 12% 22%, #fff, transparent 50%),
      radial-gradient(1.2px 1.2px at 28% 66%, #fff, transparent 50%),
      radial-gradient(1.4px 1.4px at 78% 18%, #fff, transparent 50%),
      radial-gradient(1.8px 1.8px at 56% 72%, #fff, transparent 50%),
      radial-gradient(1.3px 1.3px at 90% 48%, #fff, transparent 50%);
    animation: twinkle 9s linear infinite;
    opacity:.7;
  }
  .stars:after{ animation-delay:-4.5s; opacity:.5; }
  @keyframes twinkle{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-1px)} }

  .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center; padding:32px 16px 80px; }
  .card{
    width:min(880px, 94vw);
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    border-radius:20px;
    box-shadow:
      0 24px 60px rgba(0,0,0,.35),
      inset 0 0 60px rgba(160,140,255,.06);
    backdrop-filter: blur(10px);
    padding:22px;
  }

  header{ text-align:center; margin-bottom:6px; }
  h1{ margin:.2rem 0 .1rem; letter-spacing:.02em; font-size:1.9rem; }
  .subtitle{ color:var(--muted); font-size:.98rem; }

  .view{ display:none; } .view.active{ display:block; }
  .center{ text-align:center; }

  /* 귀여운 손글씨 */
  .hand{ font-family:"Nanum Pen Script", cursive; font-size:1.34rem; line-height:1.7; }

  /* 버튼 */
  button{
    appearance:none; border:1px solid rgba(255,255,255,.18);
    background:
      linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer;
    font-size:1rem; transition:transform .05s ease, box-shadow .2s ease, background .2s;
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
  }
  button:hover{ transform: translateY(-1px); }
  .primary{
    border-color: rgba(172,137,255,.7);
    background:
      linear-gradient(180deg, rgba(172,137,255,.60), rgba(118,209,255,.28));
    color:#0b0f28; font-weight:700;
  }
  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px; }

  /* 입력 */
  textarea{
    width:100%; min-height:110px; padding:14px 16px; border-radius:14px;
    border:1px solid rgba(255,255,255,.16); background:rgba(10,12,28,.35);
    color:var(--text); font-size:1rem; line-height:1.7; resize:vertical;
    box-shadow: inset 0 4px 12px rgba(0,0,0,.25);
  }
  .tags{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 8px; }
  .tag{ padding:8px 12px; border-radius:999px; border:1px dashed rgba(255,255,255,.32); color:var(--text); background:rgba(255,255,255,.04); cursor:pointer; }
  .tag.active{ border-style:solid; background:rgba(255,255,255,.22); color:#0b0f28; font-weight:700; }

  /* 불꽃 패널 */
  .flame-panel{ display:flex; gap:18px; align-items:center; justify-content:center; flex-wrap:wrap; padding:8px 0 4px; }
  .flame-wrap{
    width:min(360px, 86vw); aspect-ratio:3/4; position:relative; border-radius:20px;
    background:
      radial-gradient(160px 120px at 50% 70%, rgba(255,200,160,.18), transparent 60%),
      radial-gradient(260px 200px at 50% 100%, rgba(255,170,110,.14), transparent 62%);
    border:1px solid rgba(255,255,255,.15);
    box-shadow: var(--glow);
    display:flex; align-items:center; justify-content:center;
  }

  /* SVG 크기/애니메이션 */
  .flame{ width:72%; height:auto; transform-origin:50% 100%; transform: scale(var(--scale)); filter: drop-shadow(0 10px 24px rgba(255,190,120,.28)); }
  .flicker{ animation:flicker 1.6s ease-in-out infinite; }
  @keyframes flicker{ 0%{transform:scale(calc(var(--scale)*.985)) translateY(0)} 50%{transform:scale(calc(var(--scale)*1.02)) translateY(-2px)} 100%{transform:scale(calc(var(--scale)*.995)) translateY(0)} }

  .sparkles{ position:absolute; inset:0; pointer-events:none; opacity:.75; filter: blur(.3px); animation: sparkle 2.4s ease-in-out infinite; }
  @keyframes sparkle{ 0%,100%{transform:translateY(0); opacity:.6} 50%{transform:translateY(-4px); opacity:.95} }

  .note{ text-align:center; color:var(--muted); margin-top:8px; font-size:.95rem; }

  /* 기록 */
  .history{ margin-top:12px; max-height: 330px; overflow:auto; border-top:1px dashed rgba(255,255,255,.14); padding-top:12px; }
  .entry{ padding:10px 12px; border:1px solid rgba(255,255,255,.12); border-radius:14px; background:rgba(255,255,255,.06); margin-bottom:10px; }
  .entry .date{ color:var(--muted); font-size:.92rem; }
  .pill{ display:inline-block; padding:4px 8px; border-radius:999px; margin-left:6px; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.22); font-size:.85rem; }

  footer{ text-align:center; color:var(--muted); font-size:.85rem; margin-top:16px; }
  .hide{ display:none !important; }
</style>
</head>
<body>
<div class="stars"></div>
<div class="wrap">
  <main class="card">
    <header>
      <div class="subtitle">웹 교구</div>
      <h1>기도의 불씨</h1>
      <div class="subtitle">부드럽고 따뜻한 불꽃과 함께하는 기도 습관 🔥</div>
    </header>

    <!-- HOME -->
    <section id="view-home" class="view active center">
      <p class="hand" style="font-size:1.36rem;">“나의 기도 불씨를 키워보세요”</p>
      <div class="btn-row">
        <button id="btnStart" class="primary">시작하기</button>
        <button id="btnGoHistory">나의 기록 보기</button>
      </div>
    </section>

    <!-- INPUT -->
    <section id="view-input" class="view">
      <div class="hand" style="margin-bottom:8px;">하나님, 저는 …을(를) 위해 기도하고 싶어요.</div>
      <label for="txtPrayer" class="hide">기도 제목</label>
      <textarea id="txtPrayer" maxlength="300" placeholder="예: 아픈 친구의 회복을 위해, 가족의 평안을 위해, 시험을 준비하며…"></textarea>

      <div class="hand" style="margin-top:10px;">감정 태그를 선택해 주세요</div>
      <div id="tagList" class="tags" role="listbox" aria-label="감정 태그"></div>

      <div class="btn-row">
        <button id="btnSubmit" class="primary">불꽃 만들기</button>
        <button data-goto="view-home">돌아가기</button>
      </div>
      <div class="note">※ 모든 데이터는 <b>이 기기 로컬</b>에만 저장됩니다. 서버 전송 없음.</div>
    </section>

    <!-- FLAME -->
    <section id="view-flame" class="view center">
      <div class="flame-panel">
        <div id="flameContainer" class="flame-wrap stage-1" aria-live="polite">
          <!-- 새롭게 다듬은 플러피 불꽃 (부드러운 곡선 + 라운디드) -->
          <svg id="flameSVG" class="flame flicker" viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="6" result="blur"/>
                <feMerge>
                  <feMergeNode in="blur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
              <radialGradient id="gCore" cx="50%" cy="40%" r="60%">
                <stop offset="0%" stop-color="var(--flame-inner)"/>
                <stop offset="100%" stop-color="var(--flame-mid)"/>
              </radialGradient>
              <radialGradient id="gOuter" cx="50%" cy="30%" r="70%">
                <stop offset="0%" stop-color="var(--flame-mid)"/>
                <stop offset="100%" stop-color="var(--flame-outer)"/>
              </radialGradient>
            </defs>

            <!-- 둥근 외곽 불꽃 (모핑) -->
            <path id="pOuter"
              d="M100 16 C142 60 182 110 164 160 C146 208 112 238 100 246 C88 238 54 208 36 160 C18 110 58 60 100 16 Z"
              fill="url(#gOuter)" filter="url(#softGlow)" opacity=".95">
              <!-- 부드럽게 두 모양을 왕복 모핑 -->
              <animate attributeName="d" dur="3.6s" repeatCount="indefinite" values="
                M100 16 C142 60 182 110 164 160 C146 208 112 238 100 246 C88 238 54 208 36 160 C18 110 58 60 100 16 Z;
                M100 14 C146 58 182 118 160 166 C142 206 112 238 100 246 C88 238 60 206 42 166 C20 118 54 58 100 14 Z;
                M100 16 C142 60 182 110 164 160 C146 208 112 238 100 246 C88 238 54 208 36 160 C18 110 58 60 100 16 Z"/>
            </path>

            <!-- 중간층 -->
            <path id="pMid"
              d="M100 42 C132 82 158 122 146 158 C134 192 112 218 100 228 C88 218 66 192 54 158 C42 122 68 82 100 42 Z"
              fill="url(#gCore)" opacity=".97">
              <animate attributeName="d" dur="3.2s" repeatCount="indefinite" values="
                M100 42 C132 82 158 122 146 158 C134 192 112 218 100 228 C88 218 66 192 54 158 C42 122 68 82 100 42 Z;
                M100 40 C134 84 158 126 144 158 C132 190 112 216 100 226 C88 216 68 190 56 158 C42 126 66 84 100 40 Z;
                M100 42 C132 82 158 122 146 158 C134 192 112 218 100 228 C88 218 66 192 54 158 C42 122 68 82 100 42 Z"/>
            </path>

            <!-- 코어 -->
            <path id="pCore"
              d="M100 76 C118 104 130 128 124 148 C118 166 106 184 100 192 C94 184 82 166 76 148 C70 128 82 104 100 76 Z"
              fill="var(--flame-inner)" opacity=".98">
              <animate attributeName="d" dur="2.8s" repeatCount="indefinite" values="
                M100 76 C118 104 130 128 124 148 C118 166 106 184 100 192 C94 184 82 166 76 148 C70 128 82 104 100 76 Z;
                M100 74 C120 104 130 130 122 148 C116 164 106 182 100 190 C94 182 84 164 78 148 C70 130 80 104 100 74 Z;
                M100 76 C118 104 130 128 124 148 C118 166 106 184 100 192 C94 184 82 166 76 148 C70 128 82 104 100 76 Z"/>
            </path>

            <!-- 눈웃음(아주 미세, 귀여움 포인트) -->
            <g opacity=".22">
              <circle cx="86" cy="128" r="3" fill="#000"/>
              <circle cx="114" cy="128" r="3" fill="#000"/>
              <path d="M86 140 Q 100 148 114 140" stroke="#000" stroke-width="2" fill="none" stroke-linecap="round"/>
            </g>

            <!-- 작은 반짝이 -->
            <g fill="#fff" opacity=".9">
              <circle cx="76" cy="92" r="1.5">
                <animate attributeName="r" values="1.5;2.2;1.5" dur="2.6s" repeatCount="indefinite"/>
              </circle>
              <circle cx="128" cy="86" r="1.2">
                <animate attributeName="r" values="1.2;1.9;1.2" dur="2.2s" repeatCount="indefinite"/>
              </circle>
            </g>
          </svg>

          <!-- 스테이지 4에서만 보이는 별사탕 -->
          <svg id="sparkles" class="sparkles hide" viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <g fill="white" opacity="0.95">
              <path d="M30 60 l6 12 12 6 -12 6 -6 12 -6 -12 -12 -6 12 -6z"/>
              <path d="M170 90 l4 10 10 4 -10 4 -4 10 -4 -10 -10 -4 10 -4z"/>
              <path d="M70 200 l3 8 8 3 -8 3 -3 8 -3 -8 -8 -3 8 -3z"/>
              <path d="M150 200 l5 10 10 5 -10 5 -5 10 -5 -10 -10 -5 10 -5z"/>
            </g>
          </svg>
        </div>

        <div style="min-width:260px;max-width:360px">
          <h2 style="margin:0 0 6px;">당신의 기도가 불꽃이 되었어요</h2>
          <div id="statusLine" class="subtitle">참여 0회 • 단계: 붉은 불씨 🔴</div>
          <div class="entry" id="lastEntryBox" style="margin-top:10px;">
            <div class="date" id="lastDate">--</div>
            <div class="hand" id="lastText" style="font-size:1.1rem;">—</div>
            <div><span class="pill" id="lastTag">—</span></div>
          </div>
          <div class="btn-row">
            <button id="btnSaveImage" class="primary">이미지 저장</button>
            <button id="btnCopyText">텍스트 복사</button>
            <button id="btnMore">다시 입력</button>
            <button id="btnToHistory">기록 보기</button>
          </div>
          <div class="note">※ “이미지 저장”은 현재 불꽃 카드 이미지를 PNG로 저장합니다.</div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="view-history" class="view">
      <div class="center">
        <h2 style="margin:0 0 6px;">나의 불꽃 기록</h2>
        <div id="historyStatus" class="subtitle">—</div>
        <div class="btn-row">
          <button data-goto="view-input" class="primary">새 기도 남기기</button>
          <button id="btnExportText">전체 텍스트 복사</button>
          <button data-goto="view-home">홈으로</button>
        </div>
      </div>
      <div id="historyList" class="history"></div>
      <footer>로컬에 저장됨 · 이 브라우저에서만 보입니다</footer>
    </section>
  </main>
</div>

<script>
/* ===== 데이터 스키마 ===== */
const STORAGE_KEY = 'prayerSparks';
const TAGS = ['감사','간구','회복','지혜','화해','용서','평안','인도','소망','찬양'];

const views = {
  home: document.getElementById('view-home'),
  input: document.getElementById('view-input'),
  flame: document.getElementById('view-flame'),
  history: document.getElementById('view-history'),
};

const flameContainer = document.getElementById('flameContainer');
const sparkles = document.getElementById('sparkles');
const statusLine = document.getElementById('statusLine');
const lastDate = document.getElementById('lastDate');
const lastText = document.getElementById('lastText');
const lastTag = document.getElementById('lastTag');

const txtPrayer = document.getElementById('txtPrayer');
const tagList = document.getElementById('tagList');
const historyStatus = document.getElementById('historyStatus');
const historyList = document.getElementById('historyList');

let selectedTag = null;

/* ===== helpers ===== */
function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ const base={version:1, entries:[]}; localStorage.setItem(STORAGE_KEY, JSON.stringify(base)); return base; }
    const obj = JSON.parse(raw);
    if(!obj.version) obj.version=1;
    if(!Array.isArray(obj.entries)) obj.entries=[];
    return obj;
  }catch{ return {version:1, entries:[]}; }
}
function saveData(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function addEntry(text, tag){
  const data = loadData();
  const entry = { id:String(Date.now()), text:text.trim(), tag:tag||'기타', dateISO:new Date().toISOString() };
  data.entries.push(entry); saveData(data); return entry;
}
function getCount(){ return loadData().entries.length; }
function getStage(count){
  if(count>=10) return {stage:4, name:'빛나는 불꽃 ✨', className:'stage-4'};
  if(count>=5)  return {stage:3, name:'금빛 불꽃 🟡', className:'stage-3'};
  if(count>=3)  return {stage:2, name:'주황 불꽃 🟠', className:'stage-2'};
  if(count>=1)  return {stage:1, name:'붉은 불씨 🔴', className:'stage-1'};
  return {stage:0, name:'아직 없음', className:'stage-1'};
}
function formatDate(iso){
  const d = new Date(iso); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function goTo(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active'); window.scrollTo({top:0, behavior:'smooth'});
}

/* ===== UI build ===== */
function buildTags(){
  tagList.innerHTML='';
  TAGS.forEach(t=>{
    const b=document.createElement('button');
    b.type='button'; b.className='tag'; b.textContent=t; b.setAttribute('role','option');
    b.addEventListener('click', ()=>{
      selectedTag=(selectedTag===t)?null:t;
      [...tagList.children].forEach(ch=>ch.classList.toggle('active', ch.textContent===selectedTag));
    });
    tagList.appendChild(b);
  });
}
buildTags();

/* ===== submit flow ===== */
document.getElementById('btnStart').addEventListener('click', ()=>goTo('view-input'));
document.getElementById('btnGoHistory').addEventListener('click', ()=>{ renderHistory(); goTo('view-history'); });
document.querySelectorAll('[data-goto]').forEach(btn=>btn.addEventListener('click', ()=>goTo(btn.getAttribute('data-goto'))));

document.getElementById('btnSubmit').addEventListener('click', ()=>{
  const text=txtPrayer.value.trim();
  if(!text){ alert('기도 제목을 적어 주세요.'); txtPrayer.focus(); return; }
  const tag=selectedTag||'기타';
  const entry=addEntry(text, tag);
  txtPrayer.value=''; selectedTag=null; [...tagList.children].forEach(ch=>ch.classList.remove('active'));
  renderFlame(entry); goTo('view-flame');
});

/* ===== flame render ===== */
function renderFlame(latestEntry=null){
  const count=getCount(); const st=getStage(count);
  flameContainer.classList.remove('stage-1','stage-2','stage-3','stage-4'); flameContainer.classList.add(st.className);
  statusLine.textContent=`참여 ${count}회 • 단계: ${st.name}`;

  const data=loadData(); const last=latestEntry||data.entries[data.entries.length-1];
  if(last){ lastDate.textContent=formatDate(last.dateISO); lastText.textContent=last.text; lastTag.textContent=last.tag; }

  sparkles.classList.toggle('hide', st.stage!==4);
}
renderFlame();

/* ===== history render ===== */
function renderHistory(){
  const data=loadData(); const count=data.entries.length; const st=getStage(count);
  historyStatus.textContent=`참여 ${count}회 • 현재 단계: ${st.name}`;
  historyList.innerHTML='';
  const entries=[...data.entries].reverse();
  if(entries.length===0){ historyList.innerHTML=`<div class="note">아직 기록이 없어요. 오늘 첫 불씨를 남겨 보세요.</div>`; return; }
  entries.forEach(e=>{
    const div=document.createElement('div'); div.className='entry';
    div.innerHTML=`<div class="date">${formatDate(e.dateISO)} <span class="pill">${e.tag}</span></div><div class="hand" style="margin-top:6px;">${escapeHTML(e.text)}</div>`;
    historyList.appendChild(div);
  });
}

/* ===== copy/export ===== */
function buildTextSummary(){
  const data=loadData(); const count=data.entries.length; const st=getStage(count); const lines=[];
  lines.push(`【나의 기도 불꽃】`); lines.push(`참여 ${count}회 • 단계: ${st.name}`); lines.push('');
  data.entries.forEach((e,i)=>lines.push(`${i+1}. ${formatDate(e.dateISO)} [${e.tag}] ${e.text}`));
  return lines.join('\n');
}
document.getElementById('btnCopyText').addEventListener('click', async ()=>{
  const text=buildTextSummary();
  try{ await navigator.clipboard.writeText(text); toast('텍스트를 복사했어요.'); }
  catch{ prompt('복사할 텍스트입니다. 수동 복사하세요:', text); }
});
document.getElementById('btnExportText').addEventListener('click', async ()=>{
  const text=buildTextSummary();
  try{ await navigator.clipboard.writeText(text); toast('전체 기록을 복사했어요.'); }
  catch{ prompt('복사할 텍스트입니다. 수동 복사하세요:', text); }
});

/* ===== image export (SVG→PNG) ===== */
document.getElementById('btnSaveImage').addEventListener('click', async ()=>{
  const count=getCount(); const st=getStage(count); const data=loadData(); const last=data.entries[data.entries.length-1];
  const W=1000, H=1400; const c=document.createElement('canvas'); c.width=W; c.height=H; const ctx=c.getContext('2d');

  // bg
  const grd=ctx.createLinearGradient(0,0,0,H); grd.addColorStop(0,'#12183b'); grd.addColorStop(1,'#070b1e'); ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
  // halo
  ctx.fillStyle='rgba(160,140,255,.18)'; for(let i=0;i<80;i++){ const x=Math.random()*W, y=Math.random()*H*.6, r=Math.random()*1.4+.3; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }

  ctx.fillStyle='#eef1ff'; ctx.font='bold 56px "Gowun Dodum", sans-serif'; ctx.textAlign='center'; ctx.fillText('나의 기도 불꽃', W/2, 120);
  ctx.font='28px "Gowun Dodum", sans-serif'; ctx.fillStyle='#b8c0e0'; ctx.fillText(`참여 ${count}회 • ${st.name}`, W/2, 170);

  // 현재 SVG를 그대로 이미지화
  const svgNode=document.getElementById('flameSVG').cloneNode(true);
  const svgTxt=new XMLSerializer().serializeToString(svgNode);
  const svg64='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgTxt);
  await drawImage(svg64, ctx, W/2-210, 300, 420, 560);

  // 카드
  roundRect(ctx, 120, 900, W-240, 300, 18); ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fill();
  ctx.font='24px "Gowun Dodum", sans-serif'; ctx.fillStyle='#a9b2d0'; ctx.textAlign='left'; ctx.fillText(formatDate(last.dateISO)+' • '+last.tag, 150, 950);
  ctx.font='32px "Nanum Pen Script", cursive'; ctx.fillStyle='#eef1ff'; wrapText(ctx, `“${last.text}”`, 150, 996, W-300, 46);

  ctx.font='20px "Gowun Dodum", sans-serif'; ctx.fillStyle='#8e96b8'; ctx.textAlign='center'; ctx.fillText('이 이미지는 이 기기에서 개인적으로 저장되었습니다.', W/2, H-40);

  const url=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`나의_기도_불꽃_${formatDate(last.dateISO)}.png`; document.body.appendChild(a); a.click(); a.remove();
  toast('이미지를 저장했어요!');
});

/* ===== utils ===== */
function drawImage(src, ctx, x,y,w,h){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>{ctx.drawImage(img,x,y,w,h); res();}; img.onerror=rej; img.src=src; }); }
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function wrapText(ctx, text, x,y,maxWidth,lineHeight){ const chars=text.split(''); let line=''; for(let i=0;i<chars.length;i++){ const test=line+chars[i]; if(ctx.measureText(test).width>maxWidth && i>0){ ctx.fillText(line,x,y); line=chars[i]; y+=lineHeight; }else{ line=test; } } ctx.fillText(line,x,y); }
function toast(msg){ const el=document.createElement('div'); el.textContent=msg; Object.assign(el.style,{position:'fixed',left:'50%',bottom:'28px',transform:'translateX(-50%)',background:'rgba(16,18,42,.9)',color:'#eef1ff',border:'1px solid rgba(255,255,255,.15)',padding:'10px 14px',borderRadius:'10px',zIndex:9999,backdropFilter:'blur(4px)'}); document.body.appendChild(el); setTimeout(()=>{el.style.transition='opacity .4s'; el.style.opacity='0';},1400); setTimeout(()=>el.remove(),1900); }
function escapeHTML(str){ return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* ===== nav on flame ===== */
document.getElementById('btnMore').addEventListener('click', ()=>goTo('view-input'));
document.getElementById('btnToHistory').addEventListener('click', ()=>{ renderHistory(); goTo('view-history'); });

/* ===== init ===== */
function renderHistory(){ /* (위에 정의) */ }
renderHistory();
</script>
</body>
</html>
